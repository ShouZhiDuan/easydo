apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: geo-gray-release
  namespace: default
  labels:
    app: geo-gray
    release-type: geographic
spec:
  replicas: 8
  strategy:
    canary:
      steps:
      # ç¬¬ä¸€é˜¶æ®µï¼šå¼€å‘å’Œæµ‹è¯•ç¯å¢ƒ (5%)
      - setWeight: 5
      - pause: {duration: 10}
      
      # ç¬¬äºŒé˜¶æ®µï¼šåä¸œåœ°åŒº (20%)
      - setWeight: 20
      - pause: {}
      - analysis:
          templates:
          - templateName: gray-user-experience
          args:
          - name: canary-service
            value: geo-gray-canary-service.default.svc.cluster.local
          - name: stable-service
            value: geo-gray-stable-service.default.svc.cluster.local
      
      # ç¬¬ä¸‰é˜¶æ®µï¼šåå—åœ°åŒº (40%)
      - setWeight: 40
      - pause: {duration: 30}
      
      # ç¬¬å››é˜¶æ®µï¼šååŒ—å’Œåä¸­åœ°åŒº (70%)
      - setWeight: 70
      - pause: {}
      - analysis:
          templates:
          - templateName: gray-business-metrics
          args:
          - name: service-name
            value: geo-gray-canary-service.default.svc.cluster.local
      
      # ç¬¬äº”é˜¶æ®µï¼šè¥¿éƒ¨åœ°åŒºå’Œå…¨å›½ (100%)
      - setWeight: 100

      # æµé‡è·¯ç”±é…ç½®
      trafficRouting:
        nginx:
          stableIngress: geo-gray-stable-ingress
          annotationPrefix: nginx.ingress.kubernetes.io
          additionalIngressAnnotations:
            canary-by-header: "X-User-Region"
            canary-by-header-value: "east,south,north,central,west"
            canary-by-cookie: "user_region"

  selector:
    matchLabels:
      app: geo-gray
  template:
    metadata:
      labels:
        app: geo-gray
        version: "v3"
        region: "multi"
    spec:
      containers:
      - name: geo-app
        image: nginx:1.21
        ports:
        - containerPort: 80
        env:
        - name: APP_VERSION
          value: "v3.0"
        - name: DEPLOYMENT_TYPE
          value: "geographic-gray"
        - name: SUPPORTED_REGIONS
          value: "east,south,north,central,west"
        volumeMounts:
        - name: geo-config
          mountPath: /usr/share/nginx/html
        resources:
          requests:
            memory: "64Mi"
            cpu: "100m"
          limits:
            memory: "128Mi"
            cpu: "300m"
      volumes:
      - name: geo-config
        configMap:
          name: geo-gray-config
---
apiVersion: v1
kind: Service
metadata:
  name: geo-gray-stable-service
  namespace: default
  labels:
    app: geo-gray
    version: stable
spec:
  selector:
    app: geo-gray
  ports:
  - port: 80
    targetPort: 80
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: geo-gray-canary-service
  namespace: default
  labels:
    app: geo-gray
    version: canary
spec:
  selector:
    app: geo-gray
  ports:
  - port: 80
    targetPort: 80
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: geo-gray-public-service
  namespace: default
spec:
  selector:
    app: geo-gray
  ports:
  - port: 80
    targetPort: 80
    nodePort: 30083
  type: NodePort
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: geo-gray-config
  namespace: default
data:
  index.html: |
    <!DOCTYPE html>
    <html>
    <head>
        <title>åœ°ç†ä½ç½®ç°åº¦å‘å¸ƒæ¼”ç¤º</title>
        <meta charset="UTF-8">
        <style>
            body { 
                font-family: 'Microsoft YaHei', Arial, sans-serif; 
                margin: 40px; 
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                min-height: 100vh;
            }
            .container { 
                background: rgba(255,255,255,0.1); 
                padding: 30px; 
                border-radius: 15px; 
                text-align: center;
                backdrop-filter: blur(10px);
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            }
            .version { 
                font-size: 28px; 
                font-weight: bold; 
                color: #ffeaa7;
                margin-bottom: 20px;
            }
            .region-info { 
                background: rgba(0,0,0,0.2);
                padding: 20px;
                border-radius: 10px;
                margin: 20px 0;
            }
            .badge {
                background: linear-gradient(45deg, #6c5ce7, #a29bfe);
                padding: 8px 20px;
                border-radius: 25px;
                display: inline-block;
                margin: 5px;
                font-weight: bold;
            }
            .region-badge {
                background: linear-gradient(45deg, #00b894, #00cec9);
                padding: 5px 15px;
                border-radius: 20px;
                display: inline-block;
                margin: 3px;
                font-size: 14px;
            }
            .status {
                font-size: 18px;
                color: #55efc4;
                font-weight: bold;
            }
            .timeline {
                text-align: left;
                background: rgba(0,0,0,0.1);
                padding: 20px;
                border-radius: 10px;
                margin: 20px 0;
            }
            .phase {
                margin: 10px 0;
                padding: 10px;
                border-left: 4px solid #ffeaa7;
                background: rgba(255,255,255,0.05);
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>ğŸŒ åœ°ç†ä½ç½®ç°åº¦å‘å¸ƒæ¼”ç¤º</h1>
            <div class="version">ç‰ˆæœ¬: v3.0</div>
            
            <div class="region-info">
                <h3>ğŸ¯ å‘å¸ƒç­–ç•¥ï¼šåœ°ç†åˆ†åŒº</h3>
                <div class="badge">åœ°ç†ä½ç½®è·¯ç”±</div>
                <div class="badge">åˆ†åŒºå‘å¸ƒ</div>
                <div class="badge">é£é™©æ§åˆ¶</div>
                <br><br>
                <div>æ”¯æŒåœ°åŒºï¼š</div>
                <div class="region-badge">åä¸œ</div>
                <div class="region-badge">åå—</div>
                <div class="region-badge">ååŒ—</div>
                <div class="region-badge">åä¸­</div>
                <div class="region-badge">è¥¿éƒ¨</div>
            </div>

            <div class="status" id="userRegion">æ£€æµ‹ç”¨æˆ·åœ°åŒºä¸­...</div>
            
            <div class="timeline">
                <h3>ğŸ“… å‘å¸ƒæ—¶é—´çº¿</h3>
                <div class="phase">
                    <strong>é˜¶æ®µ1 (5%):</strong> å¼€å‘æµ‹è¯•ç¯å¢ƒ
                </div>
                <div class="phase">
                    <strong>é˜¶æ®µ2 (20%):</strong> åä¸œåœ°åŒºç”¨æˆ·
                </div>
                <div class="phase">
                    <strong>é˜¶æ®µ3 (40%):</strong> åå—åœ°åŒºç”¨æˆ·
                </div>
                <div class="phase">
                    <strong>é˜¶æ®µ4 (70%):</strong> ååŒ—åä¸­åœ°åŒºç”¨æˆ·
                </div>
                <div class="phase">
                    <strong>é˜¶æ®µ5 (100%):</strong> è¥¿éƒ¨åœ°åŒºå’Œå…¨å›½ç”¨æˆ·
                </div>
            </div>

            <div style="margin-top: 30px;">
                <h3>ğŸ” ç”¨æˆ·è¯†åˆ«</h3>
                <p>åŸºäºä»¥ä¸‹æ–¹å¼è¯†åˆ«ç”¨æˆ·åœ°ç†ä½ç½®ï¼š</p>
                <ul style="text-align: left;">
                    <li>ğŸ—ºï¸ IPåœ°å€åœ°ç†å®šä½</li>
                    <li>ğŸª ç”¨æˆ·Cookieä¸­çš„åœ°åŒºä¿¡æ¯</li>
                    <li>ğŸ“± HTTP Headerä¸­çš„åœ°åŒºæ ‡è¯†</li>
                    <li>ğŸ‘¤ ç”¨æˆ·è´¦æˆ·ç»‘å®šçš„åœ°åŒº</li>
                </ul>
            </div>

            <div style="margin-top: 20px; font-size: 12px; opacity: 0.8;">
                Pod: <span id="podName">${POD_NAME}</span> | 
                éƒ¨ç½²ç±»å‹: åœ°ç†ä½ç½®ç°åº¦å‘å¸ƒ | 
                æ—¶é—´: <span id="currentTime"></span>
            </div>
        </div>

        <script>
            // æ¨¡æ‹Ÿåœ°ç†ä½ç½®æ£€æµ‹
            function detectUserRegion() {
                const regions = ['åä¸œ', 'åå—', 'ååŒ—', 'åä¸­', 'è¥¿éƒ¨'];
                const cookies = document.cookie;
                const userAgent = navigator.userAgent;
                
                // æ£€æŸ¥Cookieä¸­çš„åœ°åŒºä¿¡æ¯
                let region = getCookie('user_region');
                
                // æ£€æŸ¥URLå‚æ•°
                if (!region) {
                    const urlParams = new URLSearchParams(window.location.search);
                    region = urlParams.get('region');
                }
                
                // æ¨¡æ‹ŸåŸºäºIPçš„åœ°ç†å®šä½
                if (!region) {
                    region = regions[Math.floor(Math.random() * regions.length)];
                }
                
                return region;
            }
            
            function getCookie(name) {
                const value = "; " + document.cookie;
                const parts = value.split("; " + name + "=");
                if (parts.length === 2) return parts.pop().split(";").shift();
                return null;
            }
            
            function updateDisplay() {
                const region = detectUserRegion();
                document.getElementById('userRegion').innerHTML = 
                    `ğŸŒ æ£€æµ‹åˆ°æ‚¨çš„åœ°åŒº: <span style="color: #ffeaa7;">${region}</span>`;
                
                // æ ¹æ®åœ°åŒºè®¾ç½®ä¸åŒçš„èƒŒæ™¯è‰²
                const regionColors = {
                    'åä¸œ': 'linear-gradient(135deg, #667eea, #764ba2)',
                    'åå—': 'linear-gradient(135deg, #f093fb, #f5576c)',
                    'ååŒ—': 'linear-gradient(135deg, #4facfe, #00f2fe)',
                    'åä¸­': 'linear-gradient(135deg, #43e97b, #38f9d7)',
                    'è¥¿éƒ¨': 'linear-gradient(135deg, #fa709a, #fee140)'
                };
                
                if (regionColors[region]) {
                    document.body.style.background = regionColors[region];
                }
                
                // æ›´æ–°æ—¶é—´
                document.getElementById('currentTime').textContent = 
                    new Date().toLocaleString('zh-CN');
            }
            
            // åˆå§‹åŒ–æ˜¾ç¤º
            updateDisplay();
            
            // æ¯10ç§’æ›´æ–°ä¸€æ¬¡æ—¶é—´
            setInterval(() => {
                document.getElementById('currentTime').textContent = 
                    new Date().toLocaleString('zh-CN');
            }, 10000);
        </script>
    </body>
    </html>
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: geo-gray-stable-ingress
  namespace: default
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  ingressClassName: nginx
  rules:
  - host: geo-demo.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: geo-gray-stable-service
            port:
              number: 80
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: geo-gray-canary-ingress
  namespace: default
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/canary: "true"
    nginx.ingress.kubernetes.io/canary-by-header: "X-User-Region"
    nginx.ingress.kubernetes.io/canary-by-header-value: "east,south,north,central,west"
    nginx.ingress.kubernetes.io/canary-by-cookie: "user_region"
    nginx.ingress.kubernetes.io/canary-weight: "0"
spec:
  ingressClassName: nginx
  rules:
  - host: geo-demo.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: geo-gray-canary-service
            port:
              number: 80 